{{!-- agendar.handlebars --}}

<style>
  @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500&display=swap');

  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    background: #0a0a0a;
    font-family: 'DM Sans', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  .page-agendar {
    min-height: 100vh;
    display: flex;
    background: #0a0a0a;
    position: relative;
  }

  .panel-left {
    width: 38%;
    background: #111;
    position: relative;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    justify-content: center;
    padding: 48px;
  }

  .panel-left::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(160deg, #b8860b22 0%, transparent 60%);
    pointer-events: none;
  }

  .big-letter {
    position: absolute;
    top: -40px;
    left: -20px;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 380px;
    color: #ffffff06;
    line-height: 1;
    pointer-events: none;
    user-select: none;
  }

  .barbers-label {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 11px;
    letter-spacing: 4px;
    color: #b8860b;
    margin-bottom: 32px;
    text-transform: uppercase;
  }

  .barbers-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .barber-card {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 14px 18px;
    border-radius: 10px;
    background: #1a1a1a;
    border: 1px solid #222;
    cursor: pointer;
    transition: all 0.25s ease;
    position: relative;
  }

  .barber-card:hover,
  .barber-card.active {
    border-color: #b8860b;
    background: #1c1a14;
  }

  .barber-card.active::after {
    content: 'âœ“';
    position: absolute;
    right: 16px;
    color: #b8860b;
    font-size: 14px;
    font-weight: 600;
  }

  .barber-avatar {
    width: 46px;
    height: 46px;
    border-radius: 50%;
    background: linear-gradient(135deg, #b8860b, #8b6508);
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 18px;
    color: #fff;
    flex-shrink: 0;
  }

  .barber-info h4 {
    font-size: 14px;
    font-weight: 500;
    color: #eee;
    margin-bottom: 2px;
  }

  .barber-info span {
    font-size: 11px;
    color: #666;
  }

  .panel-right {
    flex: 1;
    padding: 48px 52px;
    display: flex;
    flex-direction: column;
    overflow-y: auto;
  }

  .top-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 52px;
  }

  .logo-text {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 22px;
    color: #b8860b;
    letter-spacing: 3px;
  }

  .sair-link {
    font-size: 12px;
    color: #555;
    text-decoration: none;
    letter-spacing: 1px;
    text-transform: uppercase;
    transition: color 0.2s;
  }

  .sair-link:hover {
    color: #b8860b;
  }

  .form-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 52px;
    color: #fff;
    line-height: 1;
    margin-bottom: 6px;
  }

  .form-subtitle {
    font-size: 13px;
    color: #555;
    margin-bottom: 40px;
    letter-spacing: 0.3px;
  }

  .section-label {
    font-size: 10px;
    letter-spacing: 3px;
    text-transform: uppercase;
    color: #b8860b;
    margin-bottom: 14px;
    margin-top: 28px;
  }

  .calendar-wrapper {
    background: #111;
    border: 1px solid #222;
    border-radius: 12px;
    padding: 20px;
  }

  .cal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 18px;
  }

  .cal-nav {
    background: none;
    border: none;
    color: #b8860b;
    font-size: 18px;
    cursor: pointer;
    padding: 4px 10px;
    border-radius: 6px;
    transition: background 0.2s;
  }

  .cal-nav:hover {
    background: #1c1a14;
  }

  .cal-month {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 20px;
    color: #fff;
    letter-spacing: 2px;
  }

  .cal-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 4px;
  }

  .cal-day-name {
    text-align: center;
    font-size: 10px;
    color: #444;
    letter-spacing: 1px;
    padding-bottom: 8px;
    text-transform: uppercase;
  }

  .cal-day {
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    font-size: 13px;
    color: #888;
    cursor: pointer;
    transition: all 0.2s;
    border: 1px solid transparent;
  }

  .cal-day:hover:not(.disabled):not(.empty) {
    background: #1c1a14;
    border-color: #b8860b55;
    color: #fff;
  }

  .cal-day.today {
    border-color: #b8860b44;
    color: #b8860b;
  }

  .cal-day.selected {
    background: #b8860b;
    color: #000;
    font-weight: 600;
  }

  .cal-day.disabled {
    color: #2a2a2a;
    cursor: not-allowed;
  }

  .cal-day.empty {
    cursor: default;
  }

  .horarios-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 8px;
  }

  /* Loading nos horÃ¡rios */
  .horarios-loading {
    grid-column: 1 / -1;
    text-align: center;
    font-size: 12px;
    color: #555;
    padding: 16px;
    letter-spacing: 1px;
  }

  .horario-btn {
    background: #111;
    border: 1px solid #222;
    border-radius: 8px;
    padding: 10px 4px;
    text-align: center;
    font-size: 13px;
    color: #888;
    cursor: pointer;
    transition: all 0.2s;
    font-family: 'DM Sans', sans-serif;
  }

  .horario-btn:hover:not(.ocupado) {
    border-color: #b8860b;
    color: #fff;
    background: #1c1a14;
  }

  .horario-btn.selected {
    background: #b8860b;
    border-color: #b8860b;
    color: #000;
    font-weight: 600;
  }

  .horario-btn.ocupado {
    background: #1a0a0a;
    border-color: #2a1010;
    color: #3a1a1a;
    cursor: not-allowed;
    text-decoration: line-through;
  }

  .servicos-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
  }

  .servico-card {
    background: #111;
    border: 1px solid #222;
    border-radius: 10px;
    padding: 14px 16px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .servico-card:hover,
  .servico-card.selected {
    border-color: #b8860b;
    background: #1c1a14;
  }

  .servico-card.selected .servico-nome {
    color: #b8860b;
  }

  .servico-nome {
    font-size: 13px;
    font-weight: 500;
    color: #ccc;
    margin-bottom: 4px;
  }

  .servico-preco {
    font-size: 12px;
    color: #555;
  }

  .resumo-bar {
    margin-top: 36px;
    padding: 20px 24px;
    background: #111;
    border: 1px solid #222;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 16px;
  }

  .resumo-info {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .resumo-info span {
    font-size: 11px;
    color: #555;
    letter-spacing: 1px;
    text-transform: uppercase;
  }

  .resumo-info p {
    font-size: 14px;
    color: #ccc;
    min-height: 20px;
  }

  .btn-agendar {
    background: #b8860b;
    color: #000;
    border: none;
    padding: 14px 36px;
    border-radius: 8px;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 18px;
    letter-spacing: 2px;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
    flex-shrink: 0;
  }

  .btn-agendar:hover {
    background: #d4a012;
    transform: translateY(-1px);
  }

  .btn-agendar:disabled {
    background: #2a2a2a;
    color: #555;
    cursor: not-allowed;
    transform: none;
  }

  .msg-erro {
    color: #c0392b;
    font-size: 13px;
    margin-top: 12px;
    text-align: center;
  }

  .msg-sucesso {
    color: #27ae60;
    font-size: 13px;
    margin-top: 12px;
    text-align: center;
  }

  @media (max-width: 768px) {
    .page-agendar {
      flex-direction: column;
    }

    .panel-left {
      width: 100%;
      padding: 24px;
    }

    .big-letter {
      display: none;
    }

    .panel-right {
      padding: 28px 24px;
    }

    .horarios-grid {
      grid-template-columns: repeat(4, 1fr);
    }

    .servicos-grid {
      grid-column: 1fr;
    }

    .resumo-bar {
      flex-direction: column;
      align-items: flex-start;
    }
  }
</style>

<div class="page-agendar">

  <!-- Painel Esquerdo: Escolha do Barbeiro -->
  <div class="panel-left">
    <div class="big-letter">B</div>

    <p class="barbers-label">Escolha seu barbeiro</p>
    <div class="barbers-list" id="barbers-list">
      <div class="barber-card" data-barbeiro="ErÃ©">
        <div class="barber-avatar">E</div>
        <div class="barber-info">
          <h4>ErÃ©</h4>
        </div>
      </div>
      <div class="barber-card" data-barbeiro="Guilherme">
        <div class="barber-avatar">G</div>
        <div class="barber-info">
          <h4>Guilherme</h4>
        </div>
      </div>
    </div>
  </div>

  <!-- Painel Direito: FormulÃ¡rio -->
  <div class="panel-right">
    <div class="top-bar">
      <span class="logo-text">Barbearia</span>
      <a href="/" class="sair-link">â† Sair</a>
    </div>

    <h1 class="form-title">Novo<br>Agendamento</h1>
    <p class="form-subtitle">Selecione data, horÃ¡rio e serviÃ§o desejado</p>

    {{#if erro}}
    <div class="msg-erro">âš  {{erro}}</div>
    {{/if}}
    {{#if Sucesso}}
    <div class="msg-sucesso">
      âœ“ {{Sucesso}}
      <a href="{{whatsappLink}}" target="_blank" style="display:inline-flex;align-items:center;gap:8px;margin-top:12px;
              background:#25d366;color:#fff;padding:12px 20px;border-radius:8px;
              text-decoration:none;font-size:13px;font-weight:500;">
        <svg width="16" height="16" viewBox="0 0 32 32" fill="currentColor">
          <path
            d="M16 0C7.163 0 0 7.163 0 16c0 2.833.738 5.493 2.031 7.807L0 32l8.406-2.004A15.93 15.93 0 0016 32c8.837 0 16-7.163 16-16S24.837 0 16 0zm0 29.333a13.27 13.27 0 01-6.771-1.854l-.486-.289-5.03 1.198 1.25-4.916-.317-.504A13.226 13.226 0 012.667 16C2.667 8.636 8.636 2.667 16 2.667S29.333 8.636 29.333 16 23.364 29.333 16 29.333zm7.27-9.878c-.398-.199-2.352-1.16-2.717-1.292-.364-.133-.629-.199-.894.199-.265.398-1.027 1.292-1.259 1.557-.232.265-.464.298-.862.1-.398-.2-1.681-.62-3.203-1.977-1.184-1.057-1.983-2.362-2.215-2.76-.232-.398-.025-.613.174-.811.179-.178.398-.464.597-.696.199-.232.265-.398.398-.663.133-.265.066-.497-.033-.696-.1-.199-.894-2.154-1.225-2.95-.322-.774-.65-.669-.894-.681l-.762-.013c-.265 0-.696.1-1.06.497-.364.398-1.392 1.36-1.392 3.314s1.425 3.844 1.624 4.109c.199.265 2.804 4.28 6.793 5.998.95.41 1.69.655 2.268.838.953.303 1.82.26 2.505.158.764-.114 2.352-.961 2.683-1.889.332-.928.332-1.723.232-1.889-.099-.166-.364-.265-.762-.464z" />
        </svg>
        Confirmar pelo WhatsApp
      </a>
    </div>
    {{/if}}

    <form action="/agendar" method="post" id="form-agendar">
      <input type="hidden" name="barbeiro" id="input-barbeiro">
      <input type="hidden" name="data" id="input-data">
      <input type="hidden" name="horario" id="input-horario">
      <input type="hidden" name="servico" id="input-servico">

      <!-- CALENDÃRIO -->
      <p class="section-label">Data</p>
      <div class="calendar-wrapper">
        <div class="cal-header">
          <button type="button" class="cal-nav" id="prev-month">&#8592;</button>
          <span class="cal-month" id="cal-month-label"></span>
          <button type="button" class="cal-nav" id="next-month">&#8594;</button>
        </div>
        <div class="cal-grid" id="cal-grid"></div>
      </div>

      <!-- HORÃRIOS -->
      <p class="section-label">HorÃ¡rio</p>
      <div class="horarios-grid" id="horarios-grid">
        <div class="horarios-loading">Selecione um barbeiro e uma data</div>
      </div>

      <!-- SERVIÃ‡OS -->
      <p class="section-label">ServiÃ§o</p>
      <div class="servicos-grid">
        {{#each servicos}}
        <div class="servico-card" data-servico="{{nome}}" data-preco="R$ {{valor}}">
          <div class="servico-nome">{{nome}}</div>
          <div class="servico-preco">R$ {{valor}}</div>
        </div>
        {{/each}}
      </div>

      <!-- RESUMO + BOTÃƒO -->
      <div class="resumo-bar">
        <div class="resumo-info">
          <span>Resumo</span>
          <p id="resumo-texto">Selecione barbeiro, data, horÃ¡rio e serviÃ§o</p>
        </div>
        <button type="submit" class="btn-agendar" id="btn-submit" disabled>Confirmar</button>
      </div>
    </form>
  </div>
</div>

<script>
  const state = {
    barbeiro: null,
    data: null,
    horario: null,
    servico: null,
    servicoLabel: null,
    servicoPreco: null,
    viewYear: null,
    viewMonth: null,
  };

  const horariosTodos = ['08:00', '09:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00', '18:00', '19:00'];

  let horariosOcupados = [];  // â† carregado via fetch
  let feriadosSet = new Set(); // â† datas bloqueadas YYYY-MM-DD

  // Carrega feriados uma vez ao abrir a pÃ¡gina
  async function carregarFeriados() {
    try {
      const res = await fetch('/feriados');
      const json = await res.json();
      feriadosSet = new Set((json.feriados || []).map(f => f.data));
    } catch (e) {
      feriadosSet = new Set();
    }
  }

  function toDateStr(d) {
    return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
  }

  // â”€â”€ Busca horÃ¡rios ocupados no backend â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function buscarHorariosOcupados() {
    if (!state.barbeiro || !state.data) return;

    const dataStr = toDateStr(state.data);
    const grid = document.getElementById('horarios-grid');
    grid.innerHTML = '<div class="horarios-loading">Carregando horÃ¡rios...</div>';

    try {
      const res = await fetch(`/horarios-ocupados?barbeiro=${encodeURIComponent(state.barbeiro)}&data=${dataStr}`);
      const json = await res.json();
      horariosOcupados = json.ocupados || [];
    } catch (e) {
      horariosOcupados = [];
    }

    // Se horÃ¡rio selecionado ficou ocupado, reseta
    if (state.horario && horariosOcupados.includes(state.horario)) {
      state.horario = null;
      document.getElementById('input-horario').value = '';
    }

    renderHorarios();
    updateResumo();
  }

  // â”€â”€ CalendÃ¡rio â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const meses = ['Janeiro', 'Fevereiro', 'MarÃ§o', 'Abril', 'Maio', 'Junho',
    'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
  const dias = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'SÃ¡b'];

  function renderCalendar() {
    const y = state.viewYear, m = state.viewMonth;
    document.getElementById('cal-month-label').textContent = `${meses[m]} ${y}`;

    const grid = document.getElementById('cal-grid');
    grid.innerHTML = '';

    dias.forEach(d => {
      const el = document.createElement('div');
      el.className = 'cal-day-name';
      el.textContent = d;
      grid.appendChild(el);
    });

    const firstDay = new Date(y, m, 1).getDay();
    const totalDays = new Date(y, m + 1, 0).getDate();
    const today = new Date(); today.setHours(0, 0, 0, 0);

    for (let i = 0; i < firstDay; i++) {
      const el = document.createElement('div');
      el.className = 'cal-day empty';
      grid.appendChild(el);
    }

    for (let d = 1; d <= totalDays; d++) {
      const date = new Date(y, m, d);
      const el = document.createElement('div');
      el.className = 'cal-day';
      el.textContent = d;

      const diaSemana = date.getDay();
      const fimSemana = diaSemana === 0 || diaSemana === 6;
      const feriado = feriadosSet.has(toDateStr(date));

      if (date < today || fimSemana || feriado) {
        el.classList.add('disabled');
        if (feriado) el.title = 'Feriado â€” sem atendimento';
        if (fimSemana) el.title = 'Sem atendimento aos fins de semana';
      } else {
        if (date.getTime() === today.getTime()) el.classList.add('today');
        if (state.data && toDateStr(date) === toDateStr(state.data)) el.classList.add('selected');

        el.addEventListener('click', async () => {
          state.data = date;
          state.horario = null;
          document.getElementById('input-horario').value = '';
          renderCalendar();
          await buscarHorariosOcupados();  // â† busca ao trocar data tambÃ©m
        });
      }
      grid.appendChild(el);
    }
  }

  document.getElementById('prev-month').addEventListener('click', () => {
    state.viewMonth--;
    if (state.viewMonth < 0) { state.viewMonth = 11; state.viewYear--; }
    renderCalendar();
  });

  document.getElementById('next-month').addEventListener('click', () => {
    state.viewMonth++;
    if (state.viewMonth > 11) { state.viewMonth = 0; state.viewYear++; }
    renderCalendar();
  });

  // â”€â”€ HorÃ¡rios â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderHorarios() {
    const grid = document.getElementById('horarios-grid');
    grid.innerHTML = '';

    horariosTodos.forEach(h => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'horario-btn';
      btn.textContent = h;

      if (horariosOcupados.includes(h)) {
        btn.classList.add('ocupado');
        btn.title = 'HorÃ¡rio indisponÃ­vel';
      } else {
        if (state.horario === h) btn.classList.add('selected');
        btn.addEventListener('click', () => {
          state.horario = h;
          document.getElementById('input-horario').value = h;
          renderHorarios();
          updateResumo();
        });
      }
      grid.appendChild(btn);
    });
  }

  // â”€â”€ Barbeiros â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.querySelectorAll('.barber-card').forEach(card => {
    card.addEventListener('click', async () => {
      document.querySelectorAll('.barber-card').forEach(c => c.classList.remove('active'));
      card.classList.add('active');
      state.barbeiro = card.dataset.barbeiro;
      document.getElementById('input-barbeiro').value = state.barbeiro;
      await buscarHorariosOcupados();  // â† busca ao trocar barbeiro
    });
  });

  // â”€â”€ ServiÃ§os â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.querySelectorAll('.servico-card').forEach(card => {
    card.addEventListener('click', () => {
      document.querySelectorAll('.servico-card').forEach(c => c.classList.remove('selected'));
      card.classList.add('selected');
      state.servico = card.dataset.servico;
      state.servicoLabel = card.querySelector('.servico-nome').textContent;
      state.servicoPreco = card.dataset.preco;
      document.getElementById('input-servico').value = state.servico;
      updateResumo();
    });
  });

  // â”€â”€ Resumo + validaÃ§Ã£o â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function updateResumo() {
    const partes = [];
    if (state.barbeiro) partes.push(state.barbeiro);
    if (state.data) partes.push(state.data.toLocaleDateString('pt-BR'));
    if (state.horario) partes.push(state.horario);
    if (state.servicoLabel) partes.push(`${state.servicoLabel} (${state.servicoPreco})`);

    const p = document.getElementById('resumo-texto');
    const btn = document.getElementById('btn-submit');

    if (partes.length === 4) {
      p.textContent = partes.join(' Â· ');
      p.style.color = '#ccc';
      btn.disabled = false;
    } else {
      p.textContent = partes.length ? partes.join(' Â· ') + ' ...' : 'Selecione barbeiro, data, horÃ¡rio e serviÃ§o';
      p.style.color = '#555';
      btn.disabled = true;
    }

    if (state.data) document.getElementById('input-data').value = toDateStr(state.data);
  }

  // â”€â”€ Submit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('form-agendar').addEventListener('submit', function (e) {
    const ok = confirm(`Confirmar agendamento?\n\nğŸ‘¤ ${state.barbeiro}\nğŸ“… ${state.data.toLocaleDateString('pt-BR')} Ã s ${state.horario}\nâœ‚ï¸ ${state.servicoLabel} â€” ${state.servicoPreco}`);
    if (!ok) e.preventDefault();
  });

  // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  (async function init() {
    const now = new Date();
    state.viewYear = now.getFullYear();
    state.viewMonth = now.getMonth();
    await carregarFeriados();  // â† carrega feriados antes de renderizar
    renderCalendar();
    renderHorarios();
    updateResumo();
  })();
</script>